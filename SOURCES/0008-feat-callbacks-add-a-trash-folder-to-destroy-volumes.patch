From c427b09e7b4ee4190662852c7f95c6d848e8f26e Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Thu, 19 Dec 2019 14:17:19 +0100
Subject: [PATCH 08/12] feat(callbacks): add a trash folder to destroy volumes
 only after coalesce

---
 xapi/storage/libs/libcow/callbacks.py | 29 +++++++++++++++++++++++----
 xapi/storage/libs/libcow/coalesce.py  |  3 ++-
 2 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/xapi/storage/libs/libcow/callbacks.py b/xapi/storage/libs/libcow/callbacks.py
index 601538d..f386481 100644
--- a/xapi/storage/libs/libcow/callbacks.py
+++ b/xapi/storage/libs/libcow/callbacks.py
@@ -95,6 +95,27 @@ class Callbacks(object):
     def _remove_volume_container(self, opq, name):
         pass
 
+    def get_trash_dir(self, opq):
+        return os.path.join(opq, '.trash')
+
+    def create_trash_dir(self, opq):
+        """
+        Make a trash directory to store old data like deleted volumes.
+        """
+        util.mkdir_p(self.get_trash_dir(opq))
+
+    def empty_trash(self, opq):
+        try:
+            dir = self.get_trash_dir(opq)
+            for path in os.listdir(dir):
+                os.unlink(os.path.join(dir, path))
+        except OSError as exc:
+            if exc.errno != errno.ENOENT:
+                raise
+
+    def _get_trash_volume_path(self, opq, name):
+        return os.path.join(self.get_trash_dir(opq), name)
+
     def volumeCreate(self, opq, name, size):
         log.debug("volumeCreate opq=%s name=%s size=%d" % (opq, name, size))
         vol_path = self._create_volume_container(opq, name)
@@ -109,13 +130,13 @@ class Callbacks(object):
 
     def volumeDestroy(self, opq, name):
         log.debug("volumeDestroy opq=%s name=%s" % (opq, name))
+        self.create_trash_dir(opq)
+
         vol_path = self._get_volume_path(opq, name)
         try:
-            os.unlink(vol_path)
+            os.rename(vol_path, self._get_trash_volume_path(opq, name))
         except OSError as exc:
-            if exc.errno == errno.ENOENT:
-                pass
-            else:
+            if exc.errno != errno.ENOENT:
                 raise
 
         try:
diff --git a/xapi/storage/libs/libcow/coalesce.py b/xapi/storage/libs/libcow/coalesce.py
index c58a142..2c86567 100755
--- a/xapi/storage/libs/libcow/coalesce.py
+++ b/xapi/storage/libs/libcow/coalesce.py
@@ -329,9 +329,10 @@ def remove_garbage_volumes(uri, callbacks):
 
             if len(garbage) > 0:
                 for volume in garbage:
-                    callbacks.volumeDestroy(opq, str(volume.id))
                     with callbacks.db_context(opq) as db:
                         db.delete_volume(volume.id)
+                        callbacks.volumeDestroy(opq, str(volume.id))
+        callbacks.empty_trash(opq)
 
 
 def start_task(dbg_msg, uri, callbacks, name, args):
-- 
2.38.1

