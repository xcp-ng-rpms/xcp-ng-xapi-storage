From 88d8922d766e199762b86ae7ed0392e724497e42 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Thu, 19 Dec 2019 11:03:23 +0100
Subject: [PATCH 05/11] feat(qemudisk): use blkio and cpu cgroups

---
 xapi/storage/libs/qemudisk.py | 9 +++++++++
 xapi/storage/libs/util.py     | 7 +++++++
 2 files changed, 16 insertions(+)

diff --git a/xapi/storage/libs/qemudisk.py b/xapi/storage/libs/qemudisk.py
index 8ea8cf9..6ba846e 100644
--- a/xapi/storage/libs/qemudisk.py
+++ b/xapi/storage/libs/qemudisk.py
@@ -12,6 +12,7 @@ import cPickle
 # import image
 from xapi.storage import log
 from xapi.storage.libs import qmp
+from xapi.storage.libs import util
 from xapi.storage.libs.util import mkdir_p
 from xapi.storage.libs.util import var_run_prefix
 import xen.lowlevel.xs
@@ -19,6 +20,12 @@ import xen.lowlevel.xs
 QEMU_PROC_METADATA_FILE = "meta.pickle"
 
 QEMU_DP = "/usr/lib64/qemu-dp/bin/qemu-dp"
+
+# Use two cgroups like blktap:
+# https://github.com/xapi-project/blktap/blob/1b337b56b74d6e2387cf1681db9e12c182eb4227/control/tap-ctl-spawn.c#L241-L253
+QEMU_DP_CGROUP_BLKIO = "blkio:/vm.slice/"
+QEMU_DP_CGROUP_CPU = "cpu,cpuacct:/"
+
 NBD_CLIENT = "/usr/sbin/nbd-client"
 
 IMAGE_TYPES = frozenset(['qcow2'])
@@ -207,6 +214,8 @@ def create(dbg, key):
     log.debug("spawning qemu process with qmp socket at %s" % (qmp_sock))
     cmd = [QEMU_DP, qmp_sock]
     p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
+    util.set_cgroup(p.pid, QEMU_DP_CGROUP_BLKIO)
+    util.set_cgroup(p.pid, QEMU_DP_CGROUP_CPU)
     log.debug("new qemu process has pid %d" % (p.pid))
     return Qemudisk(p.pid, qmp_sock, key, None)
 
diff --git a/xapi/storage/libs/util.py b/xapi/storage/libs/util.py
index 21dc607..60b049c 100644
--- a/xapi/storage/libs/util.py
+++ b/xapi/storage/libs/util.py
@@ -387,3 +387,10 @@ def daemonize():
             os.close(io_pipes)
         except OSError:
             pass
+
+
+def set_cgroup(pid, cgroup):
+    try:
+        subprocess.check_call(['/usr/bin/cgclassify', '-g', cgroup, str(pid)])
+    except subprocess.CalledProcessError as e:
+        log.error('Unable to set cgroup {} of {}: {}'.format(cgroup, pid, e))
-- 
2.32.0

