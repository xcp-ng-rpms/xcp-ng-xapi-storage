From f2d24e91ef5d63273b89e9150cf47a19fa7c20f1 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Tue, 5 Nov 2019 13:53:16 +0100
Subject: [PATCH 02/11] fix(qemudisk): connect must raise only after N attempts

---
 xapi/storage/libs/qemudisk.py | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/xapi/storage/libs/qemudisk.py b/xapi/storage/libs/qemudisk.py
index 1e1f5fe..8ea8cf9 100644
--- a/xapi/storage/libs/qemudisk.py
+++ b/xapi/storage/libs/qemudisk.py
@@ -53,8 +53,9 @@ class Qemudisk(object):
             except:
                 self.qmp = None
                 time.sleep(0.1)
-                raise Exception("Connection to QMP failed: {}".format(
-                    self.qmp_sock))
+        if not self.qmp:
+            raise Exception("Connection to QMP failed: {}".format(
+                self.qmp_sock))
 
     def _qmp_disconnect(self, dbg):
         try:
-- 
2.32.0

